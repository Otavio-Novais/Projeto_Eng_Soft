name: Deploy to Heroku

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Deploy Backend to Heroku via API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
        run: |
          if [ -z "$HEROKU_API_KEY" ]; then
            echo "Error: HEROKU_API_KEY is not set"
            exit 1
          fi
          
          # Create tarball of backend directory
          cd backend
          tar -czf ../backend.tar.gz .
          cd ..
          
          # Get source upload URLs
          RESPONSE=$(curl -s -X POST "https://api.heroku.com/apps/tripsyncheroku/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          echo "API Response: $RESPONSE"
          
          PUT_URL=$(echo "$RESPONSE" | jq -r '.source_blob.put_url')
          GET_URL=$(echo "$RESPONSE" | jq -r '.source_blob.get_url')
          
          if [ "$PUT_URL" = "null" ] || [ "$GET_URL" = "null" ]; then
            echo "Error: Failed to get source URLs from Heroku API"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # Upload tarball
          curl -X PUT "$PUT_URL" \
            -H "Content-Type:" \
            --data-binary @backend.tar.gz
          
          # Trigger build
          curl -X POST "https://api.heroku.com/apps/tripsyncheroku/builds" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"source_blob\":{\"url\":\"$GET_URL\"}}"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Deploy Frontend to Heroku via API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
        run: |
          if [ -z "$HEROKU_API_KEY" ]; then
            echo "Error: HEROKU_API_KEY is not set"
            exit 1
          fi
          
          # Create tarball of frontend directory
          cd frontend/tripsync-frontend
          tar -czf ../../frontend.tar.gz .
          cd ../..
          
          # Get source upload URLs
          RESPONSE=$(curl -s -X POST "https://api.heroku.com/apps/tripsyncheroku-frontend/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY")
          
          echo "API Response: $RESPONSE"
          
          PUT_URL=$(echo "$RESPONSE" | jq -r '.source_blob.put_url')
          GET_URL=$(echo "$RESPONSE" | jq -r '.source_blob.get_url')
          
          if [ "$PUT_URL" = "null" ] || [ "$GET_URL" = "null" ]; then
            echo "Error: Failed to get source URLs from Heroku API"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # Upload tarball
          curl -X PUT "$PUT_URL" \
            -H "Content-Type:" \
            --data-binary @frontend.tar.gz
          
          # Trigger build
          curl -X POST "https://api.heroku.com/apps/tripsyncheroku-frontend/builds" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"source_blob\":{\"url\":\"$GET_URL\"}}"