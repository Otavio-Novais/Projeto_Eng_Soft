name: Deploy to Heroku

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Deploy Backend to Heroku via API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
        run: |
          # Create tarball of backend directory
          cd backend
          tar -czf ../backend.tar.gz .
          cd ..
          
          # Create source blob
          SOURCE_BLOB=$(curl -X POST "https://api.heroku.com/apps/tripsyncheroku/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" | jq -r '.source_blob.put_url')
          
          # Upload tarball
          curl -X PUT "$SOURCE_BLOB" \
            -H "Content-Type:" \
            --data-binary @backend.tar.gz
          
          # Trigger build
          SOURCE_URL=$(curl -X POST "https://api.heroku.com/apps/tripsyncheroku/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" | jq -r '.source_blob.get_url')
            
          curl -X POST "https://api.heroku.com/apps/tripsyncheroku/builds" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"source_blob\":{\"url\":\"$SOURCE_URL\"}}"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Deploy Frontend to Heroku via API
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
        run: |
          # Create tarball of frontend directory
          cd frontend/tripsync-frontend
          tar -czf ../../frontend.tar.gz .
          cd ../..
          
          # Create source blob
          SOURCE_BLOB=$(curl -X POST "https://api.heroku.com/apps/tripsyncheroku-frontend/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" | jq -r '.source_blob.put_url')
          
          # Upload tarball
          curl -X PUT "$SOURCE_BLOB" \
            -H "Content-Type:" \
            --data-binary @frontend.tar.gz
          
          # Trigger build
          SOURCE_URL=$(curl -X POST "https://api.heroku.com/apps/tripsyncheroku-frontend/sources" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" | jq -r '.source_blob.get_url')
            
          curl -X POST "https://api.heroku.com/apps/tripsyncheroku-frontend/builds" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"source_blob\":{\"url\":\"$SOURCE_URL\"}}"